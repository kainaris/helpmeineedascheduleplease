<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<title>Drive JSON Editor</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<style>
		:root {
			--bg: #0b1020;
			--card: #121934;
			--ink: #e6ecff;
			--muted: #96a0c8;
			--accent: #5b8cff;
			--ok: #35c759;
			--warn: #ff9f0a;
			--line: rgba(255, 255, 255, .08)
		}

		* {
			box-sizing: border-box
		}

		body {
			margin: 0;
			background: radial-gradient(1200px 800px at 20% -10%, #1b265a, #0b1020);
			color: var(--ink);
			font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
			min-height: 100vh;
			display: grid;
			place-items: center;
			padding: 24px
		}

		.wrap {
			width: min(960px, 100%);
			display: grid;
			gap: 16px
		}

		header {
			display: flex;
			align-items: center;
			justify-content: space-between
		}

		h1 {
			font-size: 20px;
			margin: 0
		}

		.card {
			background: linear-gradient(180deg, rgba(255, 255, 255, .04), rgba(255, 255, 255, 0));
			border: 1px solid var(--line);
			backdrop-filter: blur(6px);
			border-radius: 16px;
			padding: 16px
		}

		.row {
			display: flex;
			gap: 12px;
			flex-wrap: wrap;
			align-items: center
		}

		.pill {
			padding: 6px 10px;
			border: 1px solid rgba(255, 255, 255, .12);
			border-radius: 999px;
			color: var(--muted)
		}

		button {
			cursor: pointer;
			border: 0;
			padding: 10px 14px;
			border-radius: 12px;
			background: var(--accent);
			color: #fff;
			font-weight: 600
		}

		button.secondary {
			background: #273164
		}

		button.ghost {
			background: transparent;
			border: 1px solid rgba(255, 255, 255, .18)
		}

		button:disabled {
			opacity: .6;
			cursor: not-allowed
		}

		.meta {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			color: var(--muted);
			font-size: 12px
		}

		a {
			color: #c9d6ff;
			text-decoration: underline
		}

		.spacer {
			flex: 1
		}

		.status {
			font-size: 12px;
			color: var(--muted)
		}

		.status.ok {
			color: var(--ok)
		}

		.status.warn {
			color: var(--warn)
		}

		/* Calendar layout */
		.calendar {
			display: grid;
			grid-template-columns: 260px 1fr;
			gap: 16px;
			min-height: 420px
		}

		.sidebar {
			border: 1px solid var(--line);
			border-radius: 12px;
			overflow: hidden;
			background: #0e1533;
			display: flex;
			flex-direction: column
		}

		.sidebar-header {
			padding: 10px;
			border-bottom: 1px solid var(--line);
			display: flex;
			gap: 8px;
			align-items: center
		}

		.date-input {
			width: 100%;
			padding: 8px 10px;
			border-radius: 8px;
			border: 1px solid var(--line);
			background: #0b1130;
			color: var(--ink)
		}

		.list {
			overflow: auto
		}

		.item {
			padding: 10px 12px;
			border-bottom: 1px solid var(--line);
			cursor: pointer;
			display: flex;
			gap: 8px;
			align-items: center
		}

		.item:last-child {
			border-bottom: 0
		}

		.item.active {
			background: rgba(91, 140, 255, .15)
		}

		.item .day {
			font-weight: 700;
			min-width: 2ch
		}

		.item .summary {
			color: var(--muted);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			flex: 1
		}

		.main {
			border: 1px solid var(--line);
			border-radius: 12px;
			background: #0e1533;
			display: flex;
			flex-direction: column;
			overflow: hidden
		}

		.main-header {
			padding: 12px;
			border-bottom: 1px solid var(--line);
			display: flex;
			gap: 10px;
			align-items: center
		}

		.main-header h2 {
			margin: 0;
			font-size: 16px
		}

		.details {
			width: 100%;
			flex: 1;
			background: transparent;
			border: 0;
			color: var(--ink);
			padding: 12px;
			font: 13px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
			resize: none
		}

		.main-footer {
			padding: 12px;
			border-top: 1px solid var(--line);
			display: flex;
			gap: 8px;
			align-items: center
		}
	</style>
</head>

<body>
	<div class="wrap">
		<header>
			<h1>Google Drive JSON Editor</h1>
			<div class="row">
				<div id="g_id_onload"
					data-client_id="314049507451-oofo1sdelr7knosuu975ad6c27o8f1dk.apps.googleusercontent.com"
					data-context="signin" data-ux_mode="popup" data-callback="onSignIn"></div>
				<div class="g_id_signin" data-type="standard"></div>
			</div>
		</header>

		<div class="card">
			<div class="row">
				<div class="pill">File: <strong>helpmeineedaschedulepleasedata.json</strong></div>
				<div id="fileLink" class="pill" style="display:none"></div>
				<span class="spacer"></span>
				<button id="reloadBtn" class="ghost" disabled>Reload</button>
				<button id="saveBtn" disabled>Save</button>
			</div>
			<div class="meta" id="meta"></div>

			<!-- Calendar UI -->
			<div class="calendar">
				<aside class="sidebar">
					<div class="sidebar-header">
						<input id="newDateInput" class="date-input" type="date" />
						<button id="addBtn" class="secondary" disabled>Add</button>
					</div>
					<div id="list" class="list"></div>
				</aside>

				<section class="main">
					<div class="main-header">
						<h2 id="currentDate">No date selected</h2>
						<span class="spacer"></span>
						<button id="deleteBtn" class="ghost" disabled>Delete</button>
					</div>
					<textarea id="details" class="details" placeholder="Write details for the selected date…"
						disabled></textarea>
					<div class="main-footer">
						<span id="status" class="status">Not signed in</span>
					</div>
				</section>
			</div>
		</div>
	</div>

	<script src="https://accounts.google.com/gsi/client" async defer></script>
	<script>
		// Config
		const CLIENT_ID = "314049507451-oofo1sdelr7knosuu975ad6c27o8f1dk.apps.googleusercontent.com";
		const SCOPE = "https://www.googleapis.com/auth/drive.file";
		const FILE_NAME = "helpmeineedaschedulepleasedata.json";
		const MIME = "application/json; charset=UTF-8";

		// State
		let accessToken = null;
		let fileId = null;
		let tokenClient = null;
		let gotConsentOnce = false;

		// App model: array of {date:'YYYY-MM-DD', details:'...'}
		let model = [];
		let selectedIndex = -1;
		let dirty = false;

		// DOM
		const $ = (id) => document.getElementById(id);
		const statusEl = $("status");
		const metaEl = $("meta");
		const fileLinkEl = $("fileLink");
		const reloadBtn = $("reloadBtn");
		const saveBtn = $("saveBtn");
		const addBtn = $("addBtn");
		const deleteBtn = $("deleteBtn");
		const newDateInput = $("newDateInput");
		const listEl = $("list");
		const detailsEl = $("details");
		const currentDateEl = $("currentDate");

		// UI helpers
		function setStatus(text, cls = "") {
			statusEl.className = "status " + cls;
			statusEl.textContent = text;
		}
		function setEnabled(on) {
			[reloadBtn, saveBtn, addBtn].forEach(b => b && (b.disabled = !on));
			detailsEl.disabled = !on || selectedIndex < 0;
			deleteBtn.disabled = !on || selectedIndex < 0;
		}
		function hideSigninUi() {
			const onloadDiv = document.getElementById("g_id_onload");
			const btnDiv = document.querySelector(".g_id_signin");
			if (onloadDiv) onloadDiv.style.display = "none";
			if (btnDiv) btnDiv.style.display = "none";
		}
		function showSigninUi() {
			const onloadDiv = document.getElementById("g_id_onload");
			const btnDiv = document.querySelector(".g_id_signin");
			if (onloadDiv) onloadDiv.style.display = "";
			if (btnDiv) btnDiv.style.display = "";
		}

		// Sign-in
		async function onSignIn() {
			setStatus("Signing in…");
			tokenClient = google.accounts.oauth2.initTokenClient({
				client_id: CLIENT_ID,
				scope: SCOPE,
				callback: async (tokResp) => {
					accessToken = tokResp.access_token;
					hideSigninUi();
					setEnabled(true);
					setStatus("Signed in", "ok");
					await ensureAndLoad();
				},
				error_callback: (err) => {
					console.error(err);
					accessToken = null;
					showSigninUi();
					setEnabled(false);
					setStatus("Sign-in canceled or failed", "warn");
				},
			});
			tokenClient.requestAccessToken({ prompt: gotConsentOnce ? "" : "consent" });
			gotConsentOnce = true;
		}
		window.onSignIn = onSignIn;

		// Drive helpers
		async function driveFetch(url, options = {}) {
			if (!accessToken) throw new Error("No access token");
			const res = await fetch(url, {
				...options,
				headers: { Authorization: `Bearer ${accessToken}`, ...(options.headers || {}) },
			});
			if (!res.ok) {
				const msg = await res.text().catch(() => res.statusText);
				throw new Error(`${res.status} ${res.statusText}: ${msg}`);
			}
			return res;
		}
		async function findFileByName(name) {
			const q = encodeURIComponent(`name='${name}' and trashed=false`);
			const fields = encodeURIComponent("files(id,name,webViewLink,modifiedTime,size)");
			const res = await driveFetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=${fields}&spaces=drive`);
			const data = await res.json();
			return data.files?.[0] || null;
		}
		function buildMultipart(parts) {
			const boundary = "-------314159265358979323846";
			const crlf = "\r\n";
			let data = "";
			for (const p of parts) {
				data += `--${boundary}${crlf}`;
				data += `Content-Type: ${p.type}${crlf}${crlf}`;
				data += `${p.data}${crlf}`;
			}
			data += `--${boundary}--${crlf}`;
			return { data, contentType: `multipart/related; boundary=${boundary}` };
		}
		async function createJsonFile(name, initial = []) {
			const metadata = { name, mimeType: "application/json" };
			const body = buildMultipart([
				{ type: "application/json; charset=UTF-8", data: JSON.stringify(metadata) },
				{ type: MIME, data: JSON.stringify(initial, null, 2) }
			]);
			const res = await driveFetch(
				"https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,modifiedTime,size",
				{ method: "POST", headers: { "Content-Type": body.contentType }, body: body.data }
			);
			return res.json();
		}
		async function getFileContent(id) {
			const res = await driveFetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`);
			return res.text();
		}
		async function saveFileContent(id, text) {
			const res = await driveFetch(
				`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`,
				{ method: "PATCH", headers: { "Content-Type": MIME }, body: text }
			);
			return res.json();
		}
		function updateMeta(f) {
			const size = f.size ? `${Number(f.size).toLocaleString()} bytes` : "unknown size";
			metaEl.textContent = `Name: ${f.name} • Modified: ${new Date(f.modifiedTime).toLocaleString()} • ${size}`;
			if (fileLinkEl) {
				fileLinkEl.style.display = "inline-block";
				fileLinkEl.innerHTML = `<a href="${f.webViewLink}" target="_blank" rel="noopener">Open in Drive</a>`;
			}
		}

		// Model helpers
		function normalizeLoaded(jsonText) {
			try {
				const parsed = JSON.parse(jsonText);
				if (Array.isArray(parsed)) return parsed;
				if (parsed && typeof parsed === "object" && Array.isArray(parsed.data)) return parsed.data;
				if (parsed && typeof parsed === "object" && parsed.data && typeof parsed.data === "object") {
					// migrate object map { "2025-10-26": "details", ... } to array
					return Object.entries(parsed.data).map(([date, details]) => ({ date, details: String(details ?? "") }));
				}
				return [];
			} catch {
				return [];
			}
		}
		function sortModel() {
			model.sort((a, b) => (a.date || "").localeCompare(b.date || ""));
		}
		function renderList() {
			listEl.innerHTML = "";
			sortModel();
			model.forEach((item, idx) => {
				const el = document.createElement("div");
				el.className = "item" + (idx === selectedIndex ? " active" : "");
				const d = item.date || "";
				const day = d.split("-")[2] || "";
				const summary = (item.details || "").split("\n")[0];
				el.innerHTML = `<div class="day">${day}</div><div>${d}</div><div class="summary">${summary}</div>`;
				el.addEventListener("click", () => selectIndex(idx));
				listEl.appendChild(el);
			});
		}
		function selectIndex(idx) {
			selectedIndex = idx;
			renderList();
			const sel = model[idx];
			if (sel) {
				currentDateEl.textContent = sel.date;
				detailsEl.value = sel.details || "";
			} else {
				currentDateEl.textContent = "No date selected";
				detailsEl.value = "";
			}
			setEnabled(true);
		}
		function addDateEntry(isoDate) {
			if (!isoDate) return;
			if (!model.find(e => e.date === isoDate)) {
				model.push({ date: isoDate, details: "" });
				dirty = true;
			}
			renderList();
			const idx = model.findIndex(e => e.date === isoDate);
			selectIndex(idx);
		}
		function deleteSelected() {
			if (selectedIndex < 0) return;
			model.splice(selectedIndex, 1);
			dirty = true;
			selectedIndex = -1;
			renderList();
			selectIndex(model.length ? 0 : -1);
		}

		// Load or create
		async function ensureAndLoad() {
			try {
				setStatus("Locating file…");
				let f = await findFileByName(FILE_NAME);
				if (!f) {
					setStatus("Creating file…");
					f = await createJsonFile(FILE_NAME, []);
				}
				fileId = f.id;
				updateMeta(f);
				setStatus("Loading…");
				const text = await getFileContent(fileId);
				model = normalizeLoaded(text);
				renderList();
				selectIndex(model.length ? 0 : -1);
				setStatus("Ready", "ok");
			} catch (e) {
				setStatus(e.message, "warn");
			}
		}

		// Events
		if (reloadBtn) reloadBtn.addEventListener("click", async () => {
			if (!fileId) { await ensureAndLoad(); return; }
			try {
				setStatus("Reloading…");
				const text = await getFileContent(fileId);
				model = normalizeLoaded(text);
				renderList();
				selectIndex(model.length ? 0 : -1);
				dirty = false;
				setStatus("Ready", "ok");
			} catch (e) { setStatus(e.message, "warn"); }
		});

		if (saveBtn) saveBtn.addEventListener("click", async () => {
			if (!fileId) { setStatus("No file to save", "warn"); return; }
			try {
				setStatus("Saving…");
				const text = JSON.stringify(model, null, 2);
				await saveFileContent(fileId, text);
				const f = await findFileByName(FILE_NAME);
				if (f) updateMeta(f);
				dirty = false;
				setStatus("Saved", "ok");
			} catch (e) { setStatus(e.message, "warn"); }
		});

		if (addBtn) addBtn.addEventListener("click", () => {
			addDateEntry(newDateInput.value);
		});

		if (deleteBtn) deleteBtn.addEventListener("click", () => {
			deleteSelected();
		});

		if (detailsEl) detailsEl.addEventListener("input", () => {
			if (selectedIndex >= 0) {
				model[selectedIndex].details = detailsEl.value;
				dirty = true;
			}
		});

		// Warn on unload if dirty
		window.addEventListener("beforeunload", (e) => {
			if (dirty) { e.preventDefault(); e.returnValue = ""; }
		});
	</script>
</body>

</html>