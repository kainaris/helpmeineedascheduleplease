<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Drive JSON Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- keep your existing CSS here unchanged -->
  <style>
    /* ... your styles from the previous version ... */
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>Google Drive JSON Editor</h1>
      <div class="row">
        <div id="g_id_onload" data-client_id="314049507451-oofo1sdelr7knosuu975ad6c27o8f1dk.apps.googleusercontent.com"
          data-context="signin" data-ux_mode="popup" data-callback="onSignIn"></div>
        <div class="g_id_signin" data-type="standard"></div>
      </div>
    </header>

    <!-- keep your existing calendar UI markup here unchanged -->
    <div class="card"> <!-- controls + calendar layout --> <!-- ... --> </div>
  </div>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- App logic imports Drive helpers -->
  <script type="module">
    import {
      signIn, isSignedIn, findFileByName, createJsonFile, getFileContent, saveFileContent
    } from './drive.js';

    // constants matching your app
    const FILE_NAME = "helpmeineedaschedulepleasedata.json";

    // grab DOM once
    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const metaEl = $("meta");
    const fileLinkEl = $("fileLink");
    const reloadBtn = $("reloadBtn");
    const saveBtn = $("saveBtn");
    const addBtn = $("addBtn");
    const deleteBtn = $("deleteBtn");
    const newDateInput = $("newDateInput");
    const listEl = $("list");
    const detailsEl = $("details");
    const currentDateEl = $("currentDate");

    let fileId = null;
    let model = [];
    let selectedIndex = -1;
    let dirty = false;

    function setStatus(text, cls = "") {
      statusEl.className = "status " + cls;
      statusEl.textContent = text;
    }
    function setEnabled(on) {
      [reloadBtn, saveBtn, addBtn].forEach(b => b && (b.disabled = !on));
      detailsEl.disabled = !on || selectedIndex < 0;
      deleteBtn.disabled = !on || selectedIndex < 0;
    }
    function updateMeta(f) {
      const size = f.size ? `${Number(f.size).toLocaleString()} bytes` : "unknown size";
      metaEl.textContent = `Name: ${f.name} • Modified: ${new Date(f.modifiedTime).toLocaleString()} • ${size}`;
      if (fileLinkEl) {
        fileLinkEl.style.display = "inline-block";
        fileLinkEl.innerHTML = `<a href="${f.webViewLink}" target="_blank" rel="noopener">Open in Drive</a>`;
      }
    }

    // model helpers (same as before)
    function normalizeLoaded(jsonText) {
      try {
        const parsed = JSON.parse(jsonText);
        if (Array.isArray(parsed)) return parsed;
        if (parsed && typeof parsed === "object" && Array.isArray(parsed.data)) return parsed.data;
        if (parsed && typeof parsed === "object" && parsed.data && typeof parsed.data === "object") {
          return Object.entries(parsed.data).map(([date, details]) => ({ date, details: String(details ?? "") }));
        }
        return [];
      } catch { return []; }
    }
    function sortModel() { model.sort((a, b) => (a.date || "").localeCompare(b.date || "")); }
    function renderList() {
      listEl.innerHTML = "";
      sortModel();
      model.forEach((item, idx) => {
        const el = document.createElement("div");
        el.className = "item" + (idx === selectedIndex ? " active" : "");
        const d = item.date || "";
        const day = d.split("-")[2] || "";
        const summary = (item.details || "").split("\n")[0];
        el.innerHTML = `<div class="day">${day}</div><div>${d}</div><div class="summary">${summary}</div>`;
        el.addEventListener("click", () => selectIndex(idx));
        listEl.appendChild(el);
      });
    }
    function selectIndex(idx) {
      selectedIndex = idx;
      renderList();
      const sel = model[idx];
      if (sel) { currentDateEl.textContent = sel.date; detailsEl.value = sel.details || ""; }
      else { currentDateEl.textContent = "No date selected"; detailsEl.value = ""; }
      setEnabled(isSignedIn());
    }
    function addDateEntry(isoDate) {
      if (!isoDate) return;
      if (!model.find(e => e.date === isoDate)) { model.push({ date: isoDate, details: "" }); dirty = true; }
      renderList(); selectIndex(model.findIndex(e => e.date === isoDate));
    }
    function deleteSelected() {
      if (selectedIndex < 0) return;
      model.splice(selectedIndex, 1); dirty = true; selectedIndex = -1;
      renderList(); selectIndex(model.length ? 0 : -1);
    }

    async function ensureAndLoad() {
      try {
        setStatus("Locating file…");
        let f = await findFileByName(FILE_NAME);
        if (!f) {
          setStatus("Creating file…");
          f = await createJsonFile(FILE_NAME, []);
        }
        fileId = f.id;
        updateMeta(f);
        setStatus("Loading…");
        const text = await getFileContent(fileId);
        model = normalizeLoaded(text);
        renderList();
        selectIndex(model.length ? 0 : -1);
        setStatus("Ready", "ok");
      } catch (e) { setStatus(e.message, "warn"); }
    }

    // wire UI
    reloadBtn?.addEventListener("click", async () => {
      try {
        if (!fileId) { await ensureAndLoad(); return; }
        setStatus("Reloading…");
        const text = await getFileContent(fileId);
        model = normalizeLoaded(text);
        renderList(); selectIndex(model.length ? 0 : -1);
        dirty = false; setStatus("Ready", "ok");
      } catch (e) { setStatus(e.message, "warn"); }
    });

    saveBtn?.addEventListener("click", async () => {
      if (!fileId) { setStatus("No file to save", "warn"); return; }
      try {
        setStatus("Saving…");
        const text = JSON.stringify(model, null, 2);
        await saveFileContent(fileId, text);
        const f = await findFileByName(FILE_NAME);
        if (f) updateMeta(f);
        dirty = false; setStatus("Saved", "ok");
      } catch (e) { setStatus(e.message, "warn"); }
    });

    addBtn?.addEventListener("click", () => addDateEntry(newDateInput.value));
    deleteBtn?.addEventListener("click", () => deleteSelected());
    detailsEl?.addEventListener("input", () => {
      if (selectedIndex >= 0) { model[selectedIndex].details = detailsEl.value; dirty = true; }
    });

    // Start in signed-out state; GIS button triggers window.onSignIn -> drive.signIn()
    window.addEventListener("load", async () => {
      setEnabled(false);
      setStatus("Not signed in");
      // when sign-in completes, load file
      const originalOnSignIn = window.onSignIn;
      window.onSignIn = async () => {
        try { await signIn(); setEnabled(true); setStatus("Signed in", "ok"); await ensureAndLoad(); }
        catch { setEnabled(false); setStatus("Sign-in canceled or failed", "warn"); }
        finally { /* keep callback available for reauth */ window.onSignIn = originalOnSignIn; }
      };
    });

    window.addEventListener("beforeunload", (e) => { if (dirty) { e.preventDefault(); e.returnValue = ""; } });
  </script>
</body>

</html>