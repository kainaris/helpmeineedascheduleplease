<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<title>Drive JSON Editor</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<style>
		:root {
			--bg: #0b1020;
			--card: #121934;
			--ink: #e6ecff;
			--muted: #96a0c8;
			--accent: #5b8cff;
			--ok: #35c759;
			--warn: #ff9f0a;
			--line: rgba(255, 255, 255, .08)
		}

		* {
			box-sizing: border-box
		}

		body {
			margin: 0;
			background: radial-gradient(1200px 800px at 20% -10%, #1b265a, #0b1020);
			color: var(--ink);
			font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
			min-height: 100vh;
			display: grid;
			place-items: center;
			padding: 24px
		}

		.wrap {
			width: min(960px, 100%);
			display: grid;
			gap: 16px
		}

		header {
			display: flex;
			align-items: center;
			justify-content: space-between
		}

		h1 {
			font-size: 20px;
			margin: 0
		}

		.card {
			background: linear-gradient(180deg, rgba(255, 255, 255, .04), rgba(255, 255, 255, 0));
			border: 1px solid var(--line);
			backdrop-filter: blur(6px);
			border-radius: 16px;
			padding: 16px
		}

		.row {
			display: flex;
			gap: 12px;
			flex-wrap: wrap;
			align-items: center
		}

		button {
			cursor: pointer;
			border: 0;
			padding: 10px 14px;
			border-radius: 12px;
			background: var(--accent);
			color: #fff;
			font-weight: 600
		}

		button.secondary {
			background: #273164
		}

		button.ghost {
			background: transparent;
			border: 1px solid rgba(255, 255, 255, .18)
		}

		button:disabled {
			opacity: .6;
			cursor: not-allowed
		}

		.spacer {
			flex: 1
		}

		.status {
			font-size: 12px;
			color: var(--muted)
		}

		.status.ok {
			color: var(--ok)
		}

		.status.warn {
			color: var(--warn)
		}

		/* Layout changes */
		.calendar {
			display: grid;
			grid-template-columns: 340px 1fr;
			/* enlarged sidebar */
			gap: 16px;
			min-height: 420px
		}

		.sidebar {
			border: 1px solid var(--line);
			border-radius: 12px;
			overflow: hidden;
			background: #0e1533;
			display: flex;
			flex-direction: column
		}

		.sidebar-header {
			padding: 10px;
			border-bottom: 1px solid var(--line);
			display: flex;
			gap: 8px;
			align-items: center
		}

		.add-btn {
			width: 100%;
			display: grid;
			place-items: center;
			font-size: 18px;
			padding: 12px 14px;
			background: #273164
		}

		.list {
			overflow: auto
		}

		.item {
			padding: 10px 12px;
			border-bottom: 1px solid var(--line);
			cursor: pointer;
			display: flex;
			gap: 8px;
			align-items: center
		}

		.item:last-child {
			border-bottom: 0
		}

		.item.active {
			background: rgba(91, 140, 255, .15)
		}

		.item .summary {
			color: var(--muted);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis
		}

		.item .when {
			font-weight: 700;
			white-space: nowrap;
			margin-right: 6px
		}

		.icon-btn {
			margin-left: auto;
			background: transparent;
			border: 1px solid rgba(255, 255, 255, .18);
			padding: 6px 8px;
			border-radius: 8px;
			font-weight: 700;
			cursor: pointer
		}

		.main {
			border: 1px solid var(--line);
			border-radius: 12px;
			background: #0e1533;
			display: flex;
			flex-direction: column;
			overflow: hidden
		}

		.main-header {
			padding: 12px;
			border-bottom: 1px solid var(--line);
			display: flex;
			gap: 10px;
			align-items: center
		}

		.main-header h2 {
			margin: 0;
			font-size: 16px
		}

		.details {
			width: 100%;
			flex: 1;
			background: transparent;
			border: 0;
			color: var(--ink);
			padding: 12px;
			font: 13px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
			resize: none
		}

		.main-footer {
			padding: 12px;
			border-top: 1px solid var(--line);
			display: flex;
			gap: 8px;
			align-items: center
		}
	</style>
</head>

<body>
	<div class="wrap">
		<header>
			<h1>Google Drive JSON Editor</h1>
			<div class="row">
				<div id="g_id_onload"
					data-client_id="314049507451-oofo1sdelr7knosuu975ad6c27o8f1dk.apps.googleusercontent.com"
					data-context="signin" data-ux_mode="popup" data-auto_prompt="false" data-callback="onSignIn"></div>
				<div class="g_id_signin" data-type="standard"></div>
			</div>
		</header>

		<div class="card">
			<div class="row">
				<span class="spacer"></span>
				<button id="reloadBtn" class="ghost" disabled>Reload</button>
				<button id="saveBtn" disabled>Save</button>
			</div>

			<div class="calendar">
				<aside class="sidebar">
					<div class="sidebar-header">
						<!-- Full-width plus button, no date picker -->
						<button id="addBtn" class="add-btn" disabled aria-label="Add">+</button>
					</div>
					<div id="list" class="list"></div>
				</aside>

				<section class="main">
					<div class="main-header">
						<h2 id="currentDate">No date selected</h2>
						<span class="spacer"></span>
						<button id="deleteBtn" class="ghost" disabled>Delete</button>
					</div>
					<textarea id="details" class="details" placeholder="Write details for the selected date…"
						disabled></textarea>
					<div class="main-footer">
						<span id="status" class="status">Not signed in</span>
					</div>
				</section>
			</div>
		</div>
	</div>

	<script src="https://accounts.google.com/gsi/client" async defer></script>
	<script>
		// Config
		const CLIENT_ID = "314049507451-oofo1sdelr7knosuu975ad6c27o8f1dk.apps.googleusercontent.com";
		const SCOPE = "https://www.googleapis.com/auth/drive.file";
		const FILE_NAME = "helpmeineedaschedulepleasedata.json";
		const MIME = "application/json; charset=UTF-8";

		// Auth cache
		const LS_KEY = "drive-json-editor-token";
		const LS_CONSENT = "drive-json-editor-consented";
		let refreshTimer = null;

		// State
		let accessToken = null;
		let fileId = null;
		let tokenClient = null;

		// App model: array of {date:'YYYY-MM-DD', time:'HH:MM', details:'...'}
		let model = [];
		let selectedIndex = -1;
		let dirty = false;

		// DOM
		const $ = (id) => document.getElementById(id);
		const statusEl = $("status");
		const reloadBtn = $("reloadBtn");
		const saveBtn = $("saveBtn");
		const addBtn = $("addBtn");
		const deleteBtn = $("deleteBtn");
		const listEl = $("list");
		const detailsEl = $("details");
		const currentDateEl = $("currentDate");

		// UI helpers
		function setStatus(text, cls = "") {
			statusEl.className = "status " + cls;
			statusEl.textContent = text;
		}
		function setEnabled(on) {
			[reloadBtn, saveBtn, addBtn].forEach(b => b && (b.disabled = !on));
			detailsEl.disabled = !on || selectedIndex < 0;
			deleteBtn.disabled = !on || selectedIndex < 0;
		}
		function hideSigninUi() {
			const onloadDiv = document.getElementById("g_id_onload");
			const btnDiv = document.querySelector(".g_id_signin");
			if (onloadDiv) onloadDiv.style.display = "none";
			if (btnDiv) btnDiv.style.display = "none";
		}
		function showSigninUi() {
			const onloadDiv = document.getElementById("g_id_onload");
			const btnDiv = document.querySelector(".g_id_signin");
			if (onloadDiv) onloadDiv.style.display = "";
			if (btnDiv) btnDiv.style.display = "";
		}

		// Token cache helpers
		function saveToken(t) {
			const expAt = Date.now() + (t.expires_in ? (t.expires_in - 60) * 1000 : 50 * 60 * 1000);
			localStorage.setItem(LS_KEY, JSON.stringify({ token: t, expAt }));
		}
		function loadToken() {
			try { return JSON.parse(localStorage.getItem(LS_KEY)); }
			catch { return null; }
		}
		function clearToken() {
			localStorage.removeItem(LS_KEY);
		}
		function scheduleRefresh(t) {
			clearTimeout(refreshTimer);
			const ms = Math.max(30_000, (t.expires_in ? (t.expires_in - 120) : 1800) * 1000);
			refreshTimer = setTimeout(() => {
				try { tokenClient.requestAccessToken({ prompt: "" }); } catch { }
			}, ms);
		}

		// Init GIS and try silent auth
		function initAuth() {
			tokenClient = google.accounts.oauth2.initTokenClient({
				client_id: CLIENT_ID,
				scope: SCOPE,
				callback: async (tokResp) => {
					accessToken = tokResp.access_token;
					try { google.accounts.oauth2.setToken(tokResp); } catch { }
					saveToken(tokResp);
					localStorage.setItem(LS_CONSENT, "1");
					scheduleRefresh(tokResp);
					hideSigninUi();
					setEnabled(true);
					setStatus("Signed in", "ok");
					await ensureAndLoad();
				},
				error_callback: (err) => {
					console.error(err);
					accessToken = null;
					showSigninUi();
					setEnabled(false);
					setStatus("Sign-in canceled or failed", "warn");
				},
			});

			const cached = loadToken();
			if (cached && cached.expAt > Date.now() && cached.token?.access_token) {
				try { google.accounts.oauth2.setToken(cached.token); } catch { }
				accessToken = cached.token.access_token;
				hideSigninUi();
				setEnabled(true);
				setStatus("Signed in", "ok");
				ensureAndLoad();
				const remaining = Math.max(5_000, cached.expAt - Date.now());
				clearTimeout(refreshTimer);
				refreshTimer = setTimeout(() => tokenClient.requestAccessToken({ prompt: "" }), remaining);
			} else {
				const gotConsentOnce = localStorage.getItem(LS_CONSENT) === "1";
				if (gotConsentOnce) {
					try { tokenClient.requestAccessToken({ prompt: "" }); }
					catch { showSigninUi(); }
				} else {
					showSigninUi();
				}
			}
		}

		// Manual sign-in entry point
		async function onSignIn() {
			setStatus("Signing in…");
			try {
				if (!tokenClient) initAuth();
				const gotConsentOnce = localStorage.getItem(LS_CONSENT) === "1";
				tokenClient.requestAccessToken({ prompt: gotConsentOnce ? "" : "consent" });
			} catch (e) {
				console.error(e);
				setStatus("Sign-in init failed", "warn");
				showSigninUi();
			}
		}
		window.onSignIn = onSignIn;

		// Drive helpers
		async function driveFetch(url, options = {}) {
			if (!accessToken) throw new Error("No access token");
			const res = await fetch(url, {
				...options,
				headers: { Authorization: `Bearer ${accessToken}`, ...(options.headers || {}) },
			});
			if (res.status === 401) {
				try {
					await new Promise((resolve, reject) => {
						tokenClient.callback = (tokResp) => {
							accessToken = tokResp.access_token;
							try { google.accounts.oauth2.setToken(tokResp); } catch { }
							saveToken(tokResp);
							scheduleRefresh(tokResp);
							resolve();
						};
						tokenClient.error_callback = reject;
						tokenClient.requestAccessToken({ prompt: "" });
					});
					const retry = await fetch(url, {
						...options,
						headers: { Authorization: `Bearer ${accessToken}`, ...(options.headers || {}) },
					});
					if (!retry.ok) throw new Error(`${retry.status} ${retry.statusText}`);
					return retry;
				} catch {
					clearToken();
					showSigninUi();
					setEnabled(false);
					throw new Error("Auth expired. Sign in again.");
				}
			}
			if (!res.ok) {
				const msg = await res.text().catch(() => res.statusText);
				throw new Error(`${res.status} ${res.statusText}: ${msg}`);
			}
			return res;
		}
		async function findFileByName(name) {
			const q = encodeURIComponent(`name='${name}' and trashed=false`);
			const fields = encodeURIComponent("files(id,name,webViewLink,modifiedTime,size)");
			const res = await driveFetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=${fields}&spaces=drive`);
			const data = await res.json();
			return data.files?.[0] || null;
		}
		function buildMultipart(parts) {
			const boundary = "-------314159265358979323846";
			const crlf = "\r\n";
			let data = "";
			for (const p of parts) {
				data += `--${boundary}${crlf}`;
				data += `Content-Type: ${p.type}${crlf}${crlf}`;
				data += `${p.data}${crlf}`;
			}
			data += `--${boundary}--${crlf}`;
			return { data, contentType: `multipart/related; boundary=${boundary}` };
		}
		async function createJsonFile(name, initial = []) {
			const metadata = { name, mimeType: "application/json" };
			const body = buildMultipart([
				{ type: "application/json; charset=UTF-8", data: JSON.stringify(metadata) },
				{ type: MIME, data: JSON.stringify(initial, null, 2) }
			]);
			const res = await driveFetch(
				"https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,webViewLink,modifiedTime,size",
				{ method: "POST", headers: { "Content-Type": body.contentType }, body: body.data }
			);
			return res.json();
		}
		async function getFileContent(id) {
			const res = await driveFetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`);
			return res.text();
		}
		async function saveFileContent(id, text) {
			const res = await driveFetch(
				`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`,
				{ method: "PATCH", headers: { "Content-Type": MIME }, body: text }
			);
			return res.json();
		}

		// Model helpers
		function normalizeLoaded(jsonText) {
			try {
				const parsed = JSON.parse(jsonText);
				let arr = [];
				if (Array.isArray(parsed)) arr = parsed;
				else if (parsed && typeof parsed === "object" && Array.isArray(parsed.data)) arr = parsed.data;
				else if (parsed && typeof parsed === "object" && parsed.data && typeof parsed.data === "object") {
					arr = Object.entries(parsed.data).map(([date, details]) => ({ date, details: String(details ?? "") }));
				}
				// ensure shape {date, time, details}
				return (arr || []).map(x => ({
					date: x.date || "",
					time: x.time || "00:00",
					details: String(x.details ?? "")
				}));
			} catch {
				return [];
			}
		}
		function sortModel() {
			model.sort((a, b) => {
				const ak = (a.date || "") + "T" + (a.time || "00:00");
				const bk = (b.date || "") + "T" + (b.time || "00:00");
				return ak.localeCompare(bk);
			});
		}
		function formatWhen(dateStr, timeStr) {
			if (!dateStr) return "";
			const [y, m, d] = dateStr.split("-").map(n => Number(n));
			const [hh, mm] = (timeStr || "00:00").split(":").map(n => Number(n));
			const dt = new Date(y, (m || 1) - 1, d || 1, hh || 0, mm || 0);
			const weekday = dt.toLocaleDateString(undefined, { weekday: "long" });
			const date = dt.toISOString().slice(0, 10); // YYYY-MM-DD
			const hm = String(hh).padStart(2, "0") + ":" + String(mm).padStart(2, "0");
			return `${date} ${weekday} ${hm}`;
		}
		function renderList() {
			listEl.innerHTML = "";
			sortModel();
			model.forEach((item, idx) => {
				const el = document.createElement("div");
				el.className = "item" + (idx === selectedIndex ? " active" : "");

				const left = document.createElement("div");
				left.style.display = "flex";
				left.style.flexDirection = "column";
				left.style.flex = "1 1 auto";
				const when = document.createElement("div");
				when.className = "when";
				when.textContent = formatWhen(item.date, item.time);
				const summary = document.createElement("div");
				summary.className = "summary";
				summary.textContent = (item.details || "").split("\n")[0];
				left.appendChild(when);
				left.appendChild(summary);

				const editBtn = document.createElement("button");
				editBtn.className = "icon-btn";
				editBtn.type = "button";
				editBtn.title = "Edit date and time";
				editBtn.textContent = "✎";

				// Hidden datetime input for editing date/time
				const dtInput = document.createElement("input");
				dtInput.type = "datetime-local";
				dtInput.style.position = "fixed";
				dtInput.style.opacity = "0";
				dtInput.style.pointerEvents = "none";
				dtInput.tabIndex = -1;

				const toLocalValue = (date, time) => {
					// Build local datetime string "YYYY-MM-DDTHH:MM"
					return `${date || new Date().toISOString().slice(0, 10)}T${(time || "00:00")}`;
				};
				dtInput.value = toLocalValue(item.date, item.time);

				editBtn.addEventListener("click", (e) => {
					e.stopPropagation();
					document.body.appendChild(dtInput);
					dtInput.showPicker?.();
					dtInput.focus();
				});
				dtInput.addEventListener("change", () => {
					const v = dtInput.value; // "YYYY-MM-DDTHH:MM"
					if (v && v.includes("T")) {
						const [d, t] = v.split("T");
						model[idx].date = d;
						model[idx].time = t.slice(0, 5);
						dirty = true;
						renderList();
						if (selectedIndex === idx) updateCurrentHeader();
					}
					dtInput.remove();
				});
				dtInput.addEventListener("blur", () => dtInput.remove());

				el.addEventListener("click", () => selectIndex(idx));
				el.appendChild(left);
				el.appendChild(editBtn);
				listEl.appendChild(el);
			});
		}
		function updateCurrentHeader() {
			const sel = model[selectedIndex];
			if (sel) currentDateEl.textContent = formatWhen(sel.date, sel.time);
			else currentDateEl.textContent = "No date selected";
		}
		function selectIndex(idx) {
			selectedIndex = idx;
			renderList();
			const sel = model[idx];
			if (sel) {
				updateCurrentHeader();
				detailsEl.value = sel.details || "";
			} else {
				currentDateEl.textContent = "No date selected";
				detailsEl.value = "";
			}
			setEnabled(true);
		}
		function addDateEntryTo(dateStr) {
			if (!dateStr) return;
			if (!model.find(e => e.date === dateStr && (e.time || "00:00") === "00:00")) {
				model.push({ date: dateStr, time: "00:00", details: "" });
				dirty = true;
			}
			renderList();
			const idx = model.findIndex(e => e.date === dateStr && (e.time || "00:00") === "00:00");
			selectIndex(idx);
		}
		function deleteSelected() {
			if (selectedIndex < 0) return;
			model.splice(selectedIndex, 1);
			dirty = true;
			selectedIndex = -1;
			renderList();
			selectIndex(model.length ? 0 : -1);
		}

		// Load or create
		async function ensureAndLoad() {
			try {
				setStatus("Locating file…");
				let f = await findFileByName(FILE_NAME);
				if (!f) {
					setStatus("Creating file…");
					f = await createJsonFile(FILE_NAME, []);
				}
				fileId = f.id;
				setStatus("Loading…");
				const text = await getFileContent(fileId);
				model = normalizeLoaded(text);
				renderList();
				selectIndex(model.length ? 0 : -1);
				setStatus("Ready", "ok");
			} catch (e) {
				setStatus(e.message, "warn");
			}
		}

		// Events
		if (reloadBtn) reloadBtn.addEventListener("click", async () => {
			if (!fileId) { await ensureAndLoad(); return; }
			try {
				setStatus("Reloading…");
				const text = await getFileContent(fileId);
				model = normalizeLoaded(text);
				renderList();
				selectIndex(model.length ? 0 : -1);
				dirty = false;
				setStatus("Ready", "ok");
			} catch (e) { setStatus(e.message, "warn"); }
		});

		if (saveBtn) saveBtn.addEventListener("click", async () => {
			if (!fileId) { setStatus("No file to save", "warn"); return; }
			try {
				setStatus("Saving…");
				const text = JSON.stringify(model, null, 2);
				await saveFileContent(fileId, text);
				dirty = false;
				setStatus("Saved", "ok");
			} catch (e) { setStatus(e.message, "warn"); }
		});

		// Add button: add to current date, or today if none selected
		if (addBtn) addBtn.addEventListener("click", () => {
			let targetDate = null;
			if (selectedIndex >= 0 && model[selectedIndex]?.date) {
				targetDate = model[selectedIndex].date;
			} else {
				const now = new Date();
				// local YYYY-MM-DD
				targetDate = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().slice(0, 10);
			}
			addDateEntryTo(targetDate);
		});

		if (deleteBtn) deleteBtn.addEventListener("click", () => { deleteSelected(); });

		if (detailsEl) detailsEl.addEventListener("input", () => {
			if (selectedIndex >= 0) {
				model[selectedIndex].details = detailsEl.value;
				dirty = true;
			}
		});

		// Warn on unload if dirty
		window.addEventListener("beforeunload", (e) => {
			if (dirty) { e.preventDefault(); e.returnValue = ""; }
		});

		// Boot
		document.addEventListener("DOMContentLoaded", () => {
			const ready = () => typeof google !== "undefined";
			const boot = () => {
				try { google.accounts.id.disableAutoSelect(); } catch { }
				initAuth();
			};
			if (ready()) boot();
			else {
				const h = setInterval(() => { if (ready()) { clearInterval(h); boot(); } }, 50);
			}
		});
	</script>
</body>

</html>