<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<title>Google Drive JSON Editor</title>
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<style>
		:root {
			--bg: #0b1020;
			--card: #121934;
			--ink: #e6ecff;
			--muted: #96a0c8;
			--accent: #5b8cff;
			--ok: #35c759;
			--warn: #ff9f0a
		}

		* {
			box-sizing: border-box
		}

		body {
			margin: 0;
			background: radial-gradient(1200px 800px at 20% -10%, #1b265a, #0b1020);
			color: var(--ink);
			font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
			min-height: 100vh;
			display: grid;
			place-items: center;
			padding: 24px
		}

		.wrap {
			width: min(960px, 100%);
			display: grid;
			gap: 16px
		}

		header {
			display: flex;
			align-items: center;
			justify-content: space-between
		}

		h1 {
			font-size: 20px;
			margin: 0
		}

		.card {
			background: linear-gradient(180deg, rgba(255, 255, 255, .04), rgba(255, 255, 255, 0));
			border: 1px solid rgba(255, 255, 255, .08);
			backdrop-filter: blur(6px);
			border-radius: 16px;
			padding: 16px
		}

		.row {
			display: flex;
			gap: 12px;
			flex-wrap: wrap;
			align-items: center
		}

		.pill {
			padding: 6px 10px;
			border: 1px solid rgba(255, 255, 255, .12);
			border-radius: 999px;
			color: var(--muted)
		}

		button {
			cursor: pointer;
			border: 0;
			padding: 10px 14px;
			border-radius: 12px;
			background: var(--accent);
			color: #fff;
			font-weight: 600
		}

		button.secondary {
			background: #273164
		}

		button.ghost {
			background: transparent;
			border: 1px solid rgba(255, 255, 255, .18)
		}

		button:disabled {
			opacity: .6;
			cursor: not-allowed
		}

		textarea {
			width: 100%;
			height: 380px;
			background: #0e1533;
			border: 1px solid rgba(255, 255, 255, .12);
			border-radius: 12px;
			color: var(--ink);
			padding: 12px;
			font: 13px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
			resize: vertical
		}

		.meta {
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			color: var(--muted);
			font-size: 12px
		}

		a {
			color: #c9d6ff;
			text-decoration: underline
		}

		.spacer {
			flex: 1
		}

		.status {
			font-size: 12px;
			color: var(--muted)
		}

		.status.ok {
			color: var(--ok)
		}

		.status.warn {
			color: var(--warn)
		}

		.calendar {
			display: grid;
			grid-template-columns: 260px 1fr;
			gap: 16px;
			min-height: 420px
		}

		.sidebar {
			border: 1px solid rgba(255, 255, 255, .12);
			border-radius: 12px;
			overflow: hidden;
			background: #0e1533;
			display: flex;
			flex-direction: column
		}

		.sidebar-header {
			padding: 10px;
			border-bottom: 1px solid rgba(255, 255, 255, .12);
			display: flex;
			gap: 8px;
			align-items: center
		}

		.date-input {
			width: 100%;
			padding: 8px 10px;
			border-radius: 8px;
			border: 1px solid rgba(255, 255, 255, .12);
			background: #0b1130;
			color: var(--ink)
		}

		.list {
			overflow: auto
		}

		.item {
			padding: 10px 12px;
			border-bottom: 1px solid rgba(255, 255, 255, .12);
			cursor: pointer;
			display: flex;
			gap: 8px;
			align-items: center
		}

		.item:last-child {
			border-bottom: 0
		}

		.item.active {
			background: rgba(91, 140, 255, .15)
		}

		.item .day {
			font-weight: 700;
			min-width: 2ch
		}

		.item .summary {
			color: var(--muted);
			white-space: nowrap;
			overflow: hidden;
			text-overflow: ellipsis;
			flex: 1
		}

		.main {
			border: 1px solid rgba(255, 255, 255, .12);
			border-radius: 12px;
			background: #0e1533;
			display: flex;
			flex-direction: column;
			overflow: hidden
		}

		.main-header {
			padding: 12px;
			border-bottom: 1px solid rgba(255, 255, 255, .12);
			display: flex;
			gap: 10px;
			align-items: center
		}

		.main-header h2 {
			margin: 0;
			font-size: 16px
		}

		.details {
			width: 100%;
			flex: 1;
			background: transparent;
			border: 0;
			color: var(--ink);
			padding: 12px;
			font: 13px ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
			resize: none
		}

		.main-footer {
			padding: 12px;
			border-top: 1px solid rgba(255, 255, 255, .12);
			display: flex;
			gap: 8px;
			align-items: center
		}

		#app {
			display: none
		}
	</style>
</head>

<body>
	<div class="wrap">
		<header>
			<h1>Google Drive JSON Editor</h1>
			<div class="row">
				<!-- Plain sign-in button replaces GIS-rendered button -->
				<button id="signInBtn">Sign in with Google</button>
			</div>
		</header>

		<div id="app" class="card">
			<div class="row">
				<div class="pill">File: <strong>helpmeineedaschedulepleasedata.json</strong></div>
				<div id="fileLink" class="pill" style="display:none"></div>
				<span class="spacer"></span>
				<button id="reloadBtn" class="ghost" disabled>Reload</button>
				<button id="saveBtn" disabled>Save</button>
			</div>
			<div class="meta" id="meta"></div>

			<div class="calendar">
				<aside class="sidebar">
					<div class="sidebar-header">
						<input id="newDateInput" class="date-input" type="date" />
						<button id="addBtn" class="secondary" disabled>Add</button>
					</div>
					<div id="list" class="list"></div>
				</aside>

				<section class="main">
					<div class="main-header">
						<h2 id="currentDate">No date selected</h2>
						<span class="spacer"></span>
						<button id="deleteBtn" class="ghost" disabled>Delete</button>
					</div>
					<textarea id="details" class="details" placeholder="Write details for the selected date…"
						disabled></textarea>
					<div class="main-footer">
						<span id="status" class="status"></span>
					</div>
				</section>
			</div>
		</div>
	</div>

	<!-- Google Identity Services (needed for oauth2 token client) -->
	<script src="https://accounts.google.com/gsi/client" async defer></script>

	<script type="module">
		import {
			signIn, isSignedIn, findFileByName, createJsonFile, getFileContent, saveFileContent
		} from './drive.js';

		// Wait for GIS to be ready before attempting sign-in
		function waitForGis() {
			return new Promise((resolve) => {
				if (window.google && google.accounts && google.accounts.oauth2) return resolve();
				const t0 = Date.now();
				const i = setInterval(() => {
					if (window.google && google.accounts && google.accounts.oauth2) { clearInterval(i); resolve(); }
					else if (Date.now() - t0 > 8000) { clearInterval(i); resolve(); } // resolve anyway; signIn will throw if missing
				}, 50);
			});
		}

		const FILE_NAME = "helpmeineedaschedulepleasedata.json";

		const $ = (id) => document.getElementById(id);
		const appEl = $("app");
		const signInBtn = $("signInBtn");
		const statusEl = $("status");
		const metaEl = $("meta");
		const fileLinkEl = $("fileLink");
		const reloadBtn = $("reloadBtn");
		const saveBtn = $("saveBtn");
		const addBtn = $("addBtn");
		const deleteBtn = $("deleteBtn");
		const newDateInput = $("newDateInput");
		const listEl = $("list");
		const detailsEl = $("details");
		const currentDateEl = $("currentDate");

		let fileId = null;
		let model = [];
		let selectedIndex = -1;
		let dirty = false;

		function setStatus(text, cls = "") { statusEl.className = "status " + cls; statusEl.textContent = text; }
		function setEnabled(on) {
			[reloadBtn, saveBtn, addBtn].forEach(b => b && (b.disabled = !on));
			detailsEl.disabled = !on || selectedIndex < 0;
			deleteBtn.disabled = !on || selectedIndex < 0;
		}
		function updateMeta(f) {
			const size = f.size ? `${Number(f.size).toLocaleString()} bytes` : "unknown size";
			metaEl.textContent = `Name: ${f.name} • Modified: ${new Date(f.modifiedTime).toLocaleString()} • ${size}`;
			if (fileLinkEl) {
				fileLinkEl.style.display = "inline-block";
				fileLinkEl.innerHTML = `<a href="${f.webViewLink}" target="_blank" rel="noopener">Open in Drive</a>`;
			}
		}
		function normalizeLoaded(jsonText) {
			try {
				const parsed = JSON.parse(jsonText);
				if (Array.isArray(parsed)) return parsed;
				if (parsed && typeof parsed === "object" && Array.isArray(parsed.data)) return parsed.data;
				if (parsed && typeof parsed === "object" && parsed.data && typeof parsed.data === "object") {
					return Object.entries(parsed.data).map(([date, details]) => ({ date, details: String(details ?? "") }));
				}
				return [];
			} catch { return []; }
		}
		function sortModel() { model.sort((a, b) => (a.date || "").localeCompare(b.date || "")); }
		function renderList() {
			listEl.innerHTML = "";
			sortModel();
			model.forEach((item, idx) => {
				const el = document.createElement("div");
				el.className = "item" + (idx === selectedIndex ? " active" : "");
				const d = item.date || "";
				const day = d.split("-")[2] || "";
				const summary = (item.details || "").split("\n")[0];
				el.innerHTML = `<div class="day">${day}</div><div>${d}</div><div class="summary">${summary}</div>`;
				el.addEventListener("click", () => selectIndex(idx));
				listEl.appendChild(el);
			});
		}
		function selectIndex(idx) {
			selectedIndex = idx;
			renderList();
			const sel = model[idx];
			if (sel) { currentDateEl.textContent = sel.date; detailsEl.value = sel.details || ""; }
			else { currentDateEl.textContent = "No date selected"; detailsEl.value = ""; }
			setEnabled(true);
		}
		async function ensureAndLoad() {
			setStatus("Loading…");
			let f = await findFileByName(FILE_NAME);
			if (!f) { f = await createJsonFile(FILE_NAME, []); }
			fileId = f.id;
			updateMeta(f);
			const text = await getFileContent(fileId);
			model = normalizeLoaded(text);
			renderList();
			selectIndex(model.length ? 0 : -1);
			setStatus("Ready", "ok");
		}

		signInBtn.addEventListener("click", async () => {
			signInBtn.disabled = true;
			setStatus("Signing in…");
			await waitForGis();
			try {
				await signIn();
				signInBtn.style.display = "none";
				appEl.style.display = "";
				await ensureAndLoad();
			} catch (e) {
				setStatus("Sign-in failed", "warn");
				signInBtn.disabled = false;
			}
		});

		reloadBtn?.addEventListener("click", async () => {
			if (!fileId) { await ensureAndLoad(); return; }
			setStatus("Reloading…");
			const text = await getFileContent(fileId);
			model = normalizeLoaded(text);
			renderList(); selectIndex(model.length ? 0 : -1);
			dirty = false; setStatus("Ready", "ok");
		});
		saveBtn?.addEventListener("click", async () => {
			if (!fileId) return;
			setStatus("Saving…");
			await saveFileContent(fileId, JSON.stringify(model, null, 2));
			const f = await findFileByName(FILE_NAME);
			if (f) updateMeta(f);
			dirty = false; setStatus("Saved", "ok");
		});
		addBtn?.addEventListener("click", () => {
			const d = newDateInput.value;
			if (!d) return;
			if (!model.find(e => e.date === d)) { model.push({ date: d, details: "" }); dirty = true; }
			renderList(); selectIndex(model.findIndex(e => e.date === d));
		});
		deleteBtn?.addEventListener("click", () => {
			if (selectedIndex < 0) return;
			model.splice(selectedIndex, 1); dirty = true; selectedIndex = -1;
			renderList(); selectIndex(model.length ? 0 : -1);
		});
		detailsEl?.addEventListener("input", () => {
			if (selectedIndex >= 0) { model[selectedIndex].details = detailsEl.value; dirty = true; }
		});

		window.addEventListener("beforeunload", (e) => { if (dirty) { e.preventDefault(); e.returnValue = ""; } });
	</script>
</body>

</html>